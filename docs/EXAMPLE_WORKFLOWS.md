# Example Workflows

Ready-to-use GitHub Actions workflow examples for your repositories.

## Table of Contents

1. [Weekly Package Updates](#1-weekly-package-updates)
2. [Manual Package Updates](#2-manual-package-updates)
3. [Publish NuGet on Tag](#3-publish-nuget-on-tag)
4. [Auto-Publish on Main Push](#4-auto-publish-on-main-push)
5. [.NET Version Update](#5-net-version-update)
6. [Complete Maintenance Workflow](#6-complete-maintenance-workflow)

---

## 1. Weekly Package Updates

Automatically update NuGet packages every Monday at 3 AM.

**File:** `.github/workflows/update-packages.yml`

```yaml
name: Update NuGet Packages

on:
  schedule:
    - cron: '0 3 * * 1'  # Every Monday at 3 AM UTC
  workflow_dispatch:      # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download update scripts
        run: |
          mkdir -p tools/modules
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/update-package-versions.ps1 \
            -o tools/update-package-versions.ps1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/PackageVersionUpdater.psm1 \
            -o tools/modules/PackageVersionUpdater.psm1
      
      - name: Update package versions
        run: pwsh ./tools/update-package-versions.ps1
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: update NuGet package versions'
          title: 'Update NuGet Package Versions'
          body: |
            ?? Automated package version updates to latest compatible versions.
            
            **What changed:**
            - Updated all packages in `Directory.Packages.props`
            - Framework-aware version selection (e.g., 9.x for net9.0)
            
            **Next steps:**
            1. Review the changes
            2. Merge if tests pass
            
            ---
            Generated by: ${{ github.workflow }}
          branch: auto/update-packages
          delete-branch: true
          labels: |
            automated-task
            dependencies
```

---

## 2. Manual Package Updates

Update packages on-demand with a manual trigger.

**File:** `.github/workflows/manual-package-update.yml`

```yaml
name: Manual Package Update

on:
  workflow_dispatch:
    inputs:
      whatif:
        description: 'Preview changes only (no PR created)'
        type: boolean
        default: false

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download scripts
        run: |
          mkdir -p tools/modules
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/update-package-versions.ps1 \
            -o tools/update-package-versions.ps1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/PackageVersionUpdater.psm1 \
            -o tools/modules/PackageVersionUpdater.psm1
      
      - name: Update packages
        run: |
          if [ "${{ inputs.whatif }}" == "true" ]; then
            pwsh ./tools/update-package-versions.ps1 -WhatIf
          else
            pwsh ./tools/update-package-versions.ps1
          fi
      
      - name: Create PR
        if: inputs.whatif == false
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: update packages'
          title: 'Update NuGet Packages'
          branch: auto/update-packages
          delete-branch: true
```

---

## 3. Publish NuGet on Tag

Automatically publish NuGet packages when you create a version tag.

**File:** `.github/workflows/publish-nuget.yml`

```yaml
name: Publish NuGet Package

on:
  push:
    tags:
      - 'v*'  # Matches v1.0.0, v2.1.3, etc.

jobs:
  publish:
    uses: Zonit/.github/.github/workflows/reusable-publish-nuget.yml@master
    secrets:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
    with:
      source_directory: 'Source'  # Adjust to your source directory
```

**Setup:**
1. Add `NUGET_API_KEY` secret to your repository
2. Create a tag: `git tag v1.0.0 && git push origin v1.0.0`
3. Workflow triggers automatically

---

## 4. Auto-Publish on Main Push

Automatically check and publish new versions when pushing to main.

**File:** `.github/workflows/auto-publish.yml`

```yaml
name: Auto-Publish NuGet

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  check-and-publish:
    uses: Zonit/.github/.github/workflows/reusable-check-nuget-and-publish.yml@master
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    with:
      source_directory: 'Source'
```

**Behavior:**
- Compares local version with nuget.org
- Only publishes if local version is newer
- No unnecessary builds

---

## 5. .NET Version Update

Update .NET framework version with a manual workflow.

**File:** `.github/workflows/update-dotnet.yml`

```yaml
name: Update .NET Version

on:
  workflow_dispatch:
    inputs:
      target-frameworks:
        description: 'Target frameworks (e.g., "net9.0" or "net8.0,net9.0")'
        required: true
        default: 'net9.0'
      create-pr:
        description: 'Create pull request'
        type: boolean
        default: true

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download update scripts
        run: |
          mkdir -p tools/modules
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/update-dotnet-simple.ps1 \
            -o tools/update-dotnet-simple.ps1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/NuGetPackageService.psm1 \
            -o tools/modules/NuGetPackageService.psm1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/DotNetProjectManager.psm1 \
            -o tools/modules/DotNetProjectManager.psm1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/CentralPackageManager.psm1 \
            -o tools/modules/CentralPackageManager.psm1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/PackageVersionUpdater.psm1 \
            -o tools/modules/PackageVersionUpdater.psm1
      
      - name: Update .NET version
        run: |
          # Convert comma-separated string to array
          FW_B64=$(echo -n '${{ inputs.target-frameworks }}' | base64)
          
          cat > run-update.ps1 << 'PWSH_WRAPPER'
          param([string]$FrameworksB64)
          $frameworksStr = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($FrameworksB64))
          $frameworks = $frameworksStr -split ','
          & ./tools/update-dotnet-simple.ps1 -TargetFrameworks $frameworks
          PWSH_WRAPPER
          
          pwsh -NoProfile -NonInteractive -File run-update.ps1 -FrameworksB64 "$FW_B64"
      
      - name: Create Pull Request
        if: inputs.create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: update .NET to ${{ inputs.target-frameworks }}'
          title: 'Update .NET to ${{ inputs.target-frameworks }}'
          body: |
            ?? .NET version update
            
            **Target frameworks:** `${{ inputs.target-frameworks }}`
            
            **What changed:**
            - Updated `TargetFramework(s)` in .csproj files
            - Updated/created `Directory.Packages.props`
            - Updated all package versions to latest compatible
            
            **Next steps:**
            1. Review changes
            2. Run `dotnet restore`
            3. Run `dotnet build`
            4. Run tests
            5. Merge when ready
          branch: auto/update-dotnet-${{ inputs.target-frameworks }}
          delete-branch: true
          labels: |
            automated-task
            dotnet-update
```

---

## 6. Complete Maintenance Workflow

Combines multiple maintenance tasks in one workflow.

**File:** `.github/workflows/maintenance.yml`

```yaml
name: Maintenance

on:
  schedule:
    - cron: '0 3 * * 1'  # Weekly, Monday 3 AM
  workflow_dispatch:
    inputs:
      update-packages:
        description: 'Update NuGet packages'
        type: boolean
        default: true
      update-dotnet:
        description: 'Update .NET version'
        type: boolean
        default: false
      target-frameworks:
        description: 'Target frameworks (if updating .NET)'
        type: string
        default: 'net9.0'

jobs:
  # Job 1: Update NuGet packages
  update-packages:
    if: github.event_name == 'schedule' || inputs.update-packages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download scripts
        run: |
          mkdir -p tools/modules
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/update-package-versions.ps1 \
            -o tools/update-package-versions.ps1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/PackageVersionUpdater.psm1 \
            -o tools/modules/PackageVersionUpdater.psm1
      
      - name: Update packages
        run: pwsh ./tools/update-package-versions.ps1
      
      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: weekly package updates'
          title: '[Maintenance] Weekly NuGet Package Updates'
          body: |
            ?? Automated weekly package updates
            
            **Schedule:** Every Monday at 3 AM UTC
            
            **Changes:**
            - Updated packages in `Directory.Packages.props`
            - All packages updated to latest compatible versions
            
            **Testing:**
            - [ ] `dotnet restore` passes
            - [ ] `dotnet build` passes
            - [ ] All tests pass
          branch: auto/weekly-package-updates
          delete-branch: true
          labels: |
            automated-task
            maintenance
            dependencies

  # Job 2: Update .NET version (manual only)
  update-dotnet:
    if: github.event_name == 'workflow_dispatch' && inputs.update-dotnet
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all scripts
        run: |
          mkdir -p tools/modules
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/update-dotnet-simple.ps1 \
            -o tools/update-dotnet-simple.ps1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/NuGetPackageService.psm1 \
            -o tools/modules/NuGetPackageService.psm1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/DotNetProjectManager.psm1 \
            -o tools/modules/DotNetProjectManager.psm1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/CentralPackageManager.psm1 \
            -o tools/modules/CentralPackageManager.psm1
          curl -fsSL https://raw.githubusercontent.com/Zonit/.github/refs/heads/master/tools/modules/PackageVersionUpdater.psm1 \
            -o tools/modules/PackageVersionUpdater.psm1
      
      - name: Update .NET
        run: |
          FW_B64=$(echo -n '${{ inputs.target-frameworks }}' | base64)
          cat > run-update.ps1 << 'PWSH_WRAPPER'
          param([string]$FrameworksB64)
          $frameworksStr = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($FrameworksB64))
          $frameworks = $frameworksStr -split ','
          & ./tools/update-dotnet-simple.ps1 -TargetFrameworks $frameworks
          PWSH_WRAPPER
          pwsh -NoProfile -NonInteractive -File run-update.ps1 -FrameworksB64 "$FW_B64"
      
      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: update .NET to ${{ inputs.target-frameworks }}'
          title: '[Maintenance] Update .NET to ${{ inputs.target-frameworks }}'
          body: |
            ?? .NET framework update
            
            **Target:** `${{ inputs.target-frameworks }}`
            
            **Review checklist:**
            - [ ] All projects updated
            - [ ] Directory.Packages.props created/updated
            - [ ] Package versions updated
            - [ ] No build errors
            - [ ] All tests pass
          branch: auto/update-dotnet
          delete-branch: true
          labels: |
            automated-task
            maintenance
            dotnet-update
```

---

## Usage Instructions

### Setting Up a Workflow

1. **Create the workflow directory:**
   ```bash
   mkdir -p .github/workflows
   ```

2. **Copy desired workflow:**
   - Choose from examples above
   - Save to `.github/workflows/[name].yml`

3. **Configure secrets (if needed):**
   - Go to repository Settings ? Secrets
   - Add required secrets (e.g., `NUGET_API_KEY`)

4. **Adjust parameters:**
   - Source directory paths
   - Schedule times (cron)
   - Branch names

5. **Test the workflow:**
   - Go to Actions tab
   - Select the workflow
   - Click "Run workflow"

### Best Practices

1. **Start with manual triggers** (`workflow_dispatch`) before enabling schedules
2. **Test on a feature branch** before applying to main
3. **Review PR descriptions** and adjust to your team's needs
4. **Set up branch protection** to require reviews for automated PRs
5. **Monitor workflow runs** in the Actions tab

### Combining Workflows

You can combine multiple workflows in one file (see example #6) or keep them separate:

**Advantages of separate files:**
- Easier to enable/disable individual tasks
- Clearer workflow history
- Independent schedules

**Advantages of combined files:**
- Less duplication
- Single maintenance workflow to manage
- Easier to trigger all tasks at once

---

## Troubleshooting

### Workflow Not Triggering on Schedule

**Possible causes:**
- Repository has no recent activity (GitHub disables scheduled workflows)
- Cron syntax error
- Wrong branch (schedules only work on default branch)

**Solution:**
- Make a commit to re-enable
- Validate cron syntax: https://crontab.guru/
- Ensure workflow file is on default branch

### PR Not Created

**Causes:**
- No changes detected (already up-to-date)
- Missing `contents: write` or `pull-requests: write` permissions
- Branch protection rules blocking bot

**Solution:**
- Check workflow logs for "No changes"
- Add required permissions to workflow
- Allow GitHub Actions bot in branch protection

### Script Download Fails

**Causes:**
- Network issues
- Wrong URL
- Private repository (raw.githubusercontent.com requires auth)

**Solution:**
- Use stable URLs (refs/heads/master)
- Check URL in browser
- For private repos, use authenticated API calls

---

## Advanced Customization

### Custom PR Labels

Add custom labels to PRs:

```yaml
- name: Create PR
  uses: peter-evans/create-pull-request@v5
  with:
    # ...
    labels: |
      automated-task
      high-priority
      dependencies
      security
```

### Slack Notifications

Add Slack notification on PR creation:

```yaml
- name: Notify Slack
  if: steps.create-pr.outputs.pull-request-number
  uses: slackapi/slack-github-action@v1
  with:
    payload: |
      {
        "text": "New maintenance PR created: ${{ steps.create-pr.outputs.pull-request-url }}"
      }
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### Auto-Merge

Enable auto-merge for low-risk updates:

```yaml
- name: Enable auto-merge
  if: steps.create-pr.outputs.pull-request-number
  run: |
    gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
      --auto --squash
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**?? Warning:** Only use with good test coverage and branch protection!

---

## Support

Need help with workflows?
- Check [GitHub Actions documentation](https://docs.github.com/actions)
- Review workflow logs in Actions tab
- Open an issue in the `.github` repository

---

**Last Updated:** 2024
**Maintained by:** Zonit DevOps Team
